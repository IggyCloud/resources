pg_postmaster_cpu_stats:
  master: true
  cache_seconds: 30
  query: |
    SELECT
      datname as database,
      usename as user,
      application_name,
      state,
      COUNT(*) as connections,
      EXTRACT(EPOCH FROM MAX(now() - backend_start)) as max_connection_age_seconds,
      EXTRACT(EPOCH FROM AVG(now() - backend_start)) as avg_connection_age_seconds
    FROM pg_stat_activity
    WHERE state IS NOT NULL
    GROUP BY datname, usename, application_name, state
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - user:
        usage: "LABEL"
        description: "User name"
    - application_name:
        usage: "LABEL"
        description: "Application name"
    - state:
        usage: "LABEL"
        description: "Connection state"
    - connections:
        usage: "GAUGE"
        description: "Number of connections"
    - max_connection_age_seconds:
        usage: "GAUGE"
        description: "Maximum connection age in seconds"
    - avg_connection_age_seconds:
        usage: "GAUGE"
        description: "Average connection age in seconds"

pg_database_stats:
  master: true
  cache_seconds: 60
  query: |
    SELECT
      datname as database,
      numbackends as connections,
      xact_commit as commits,
      xact_rollback as rollbacks,
      blks_read as blocks_read,
      blks_hit as blocks_hit,
      tup_returned as tuples_returned,
      tup_fetched as tuples_fetched,
      tup_inserted as tuples_inserted,
      tup_updated as tuples_updated,
      tup_deleted as tuples_deleted
    FROM pg_stat_database
    WHERE datname NOT IN ('template0', 'template1')
  metrics:
    - database:
        usage: "LABEL"
        description: "Database name"
    - connections:
        usage: "GAUGE"
        description: "Number of backends currently connected to this database"
    - commits:
        usage: "COUNTER"
        description: "Number of transactions committed"
    - rollbacks:
        usage: "COUNTER"
        description: "Number of transactions rolled back"
    - blocks_read:
        usage: "COUNTER"
        description: "Number of disk blocks read"
    - blocks_hit:
        usage: "COUNTER"
        description: "Number of buffer hits"
    - tuples_returned:
        usage: "COUNTER"
        description: "Number of rows returned by queries"
    - tuples_fetched:
        usage: "COUNTER"
        description: "Number of rows fetched by queries"
    - tuples_inserted:
        usage: "COUNTER"
        description: "Number of rows inserted"
    - tuples_updated:
        usage: "COUNTER"
        description: "Number of rows updated"
    - tuples_deleted:
        usage: "COUNTER"
        description: "Number of rows deleted"

pg_locks_stats:
  master: true
  cache_seconds: 30
  query: |
    SELECT
      mode,
      locktype,
      granted::int as granted_count,
      COUNT(*) as total_locks
    FROM pg_locks
    GROUP BY mode, locktype, granted
  metrics:
    - mode:
        usage: "LABEL"
        description: "Lock mode"
    - locktype:
        usage: "LABEL"
        description: "Lock type"
    - granted_count:
        usage: "LABEL"
        description: "Whether lock was granted (1) or not (0)"
    - total_locks:
        usage: "GAUGE"
        description: "Total number of locks"